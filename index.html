<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Log Mobile v2.2</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        h2 { text-align: center; margin: 5px 0 15px 0; color: #007bff; font-size: 1.2rem; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 13px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end;}
        .col { flex: 1; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: opacity 0.2s; }
        .btn-gps { background: #e3f2fd; color: #007bff; border: 1px solid #b3d7ff; }
        .btn-save { background: #28a745; color: white; box-shadow: 0 4px 6px rgba(40,167,69,0.2); margin-top: 10px;}
        .btn-export { background: #ff9800; color: white; }
        .btn-clear { background: #dc3545; color: white; font-size: 14px; padding: 8px; margin-top: 5px;}
        .btn-now { width: auto; padding: 10px; font-size: 12px; background: #6c757d; color: white; margin-bottom: 5px; margin-left: 5px;}
        
        #logList { list-style: none; padding: 0; }
        .log-item { background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-item:last-child { border-bottom: none; }
        .log-info { font-size: 15px; font-weight: 500; }
        .log-sub { font-size: 12px; color: #666; margin-top: 2px; }
        
        .weather-area { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .weather-row { display: flex; gap: 8px; font-size: 12px; }
        .weather-row input { font-size: 14px; padding: 6px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h2>ğŸ“¡ Radio Logbook Mobile v2.2</h2>

    <div class="card">
        <div class="row">
            <div class="col">
                <label>æ—¥ä»˜</label>
                <input type="date" id="date">
            </div>
        </div>
        
        <div class="row">
            <div class="col" style="flex:2;">
                <label>é–‹å§‹æ™‚åˆ»</label>
                <div style="display:flex;">
                    <input type="time" id="time">
                    <button type="button" class="btn-now" onclick="setNow('time')">ä»Š</button>
                </div>
            </div>
             </div>

        <button type="button" class="btn-gps" onclick="getGPSAndWeather()">ğŸ›°ï¸ GPS & å¤©æ°—å–å¾—</button>
        <input type="text" id="my_location" placeholder="é‹ç”¨åœ° (ç·¯åº¦,çµŒåº¦)">

        <div class="weather-area">
            <label>æ°—è±¡ãƒ‡ãƒ¼ã‚¿ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚è‡ªå‹•å–å¾—)</label>
            <div class="row">
                <div class="col"><input type="text" id="weather" placeholder="å¤©æ°—"></div>
                <div class="col"><input type="number" id="temp" placeholder="â„ƒ" step="0.1"></div>
            </div>
            <div class="weather-row">
                <div class="col"><input type="number" id="humid" placeholder="%" step="1"></div>
                <div class="col"><input type="number" id="press" placeholder="hPa" step="1"></div>
                <div class="col"><input type="number" id="wind" placeholder="m/s" step="0.1"></div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Callsign</label>
                <input type="text" id="callsign" placeholder="ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³" style="text-transform: uppercase;">
            </div>
            <div class="col">
                <label>Band</label>
                <select id="band">
                    <option>å¸‚æ°‘ãƒ©ã‚¸ã‚ª/CB</option>
                    <option>ãƒ‡ã‚¸ã‚¿ãƒ«ç°¡æ˜“ç„¡ç·š/DCR</option>
                    <option>ç‰¹å®šå°é›»åŠ›ç„¡ç·š/SLPR</option>
                    <option>ãƒ‡ã‚¸ã‚¿ãƒ«å°é›»åŠ›ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£/LCR</option>
                    <option>ã‚¢ãƒãƒãƒ¥ã‚¢ç„¡ç·š/Ham</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col"><label>Ch</label><input type="text" id="channel" placeholder="ch"></div>
            <div class="col"><label>RS</label><input type="text" id="rs" placeholder="ãƒ¬ãƒãƒ¼ãƒˆ"></div>
        </div>

        <label>ç›¸æ‰‹åœ° / å‚™è€ƒ</label>
        <input type="text" id="location" placeholder="ç›¸æ‰‹å±€ã®é‹ç”¨åœ°ãªã©">
        
        <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea id="content" rows="2" placeholder="äº¤ä¿¡ãƒ¡ãƒ¢"></textarea>

        <button type="button" class="btn-save" onclick="addLog()">ğŸ’¾ ãƒ­ã‚°ä¿å­˜</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0; font-size:16px;">ä¿å­˜æ¸ˆã¿: <span id="count">0</span>ä»¶</h3>
        <button type="button" class="btn-export" onclick="exportJSON()">ğŸ“¤ JSONæ›¸å‡º (PCé€£æºç”¨)</button>
        <ul id="logList"></ul>
        <div style="text-align: right;">
            <button type="button" class="btn-clear" onclick="clearLogs()">å…¨å‰Šé™¤</button>
        </div>
    </div>

    <script>
        // åˆæœŸåŒ–
        const now = new Date();
        document.getElementById('date').value = now.toISOString().slice(0, 10);
        document.getElementById('time').value = now.toTimeString().slice(0, 5);
        
        let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
        renderLogs();

        // å¤©æ°—ã‚³ãƒ¼ãƒ‰å¤‰æ›è¡¨
        const weatherCodes = {
            0: "å¿«æ™´", 1: "æ™´ã‚Œ", 2: "ä¸€éƒ¨æ›‡", 3: "æ›‡ã‚Š",
            45: "éœ§", 48: "éœ§æ°·", 51: "éœ§é›¨", 53: "éœ§é›¨", 55: "éœ§é›¨",
            61: "é›¨", 63: "é›¨", 65: "å¤§é›¨", 80: "ã«ã‚ã‹é›¨", 81: "è±ªé›¨",
            71: "é›ª", 73: "é›ª", 75: "å¤§é›ª", 95: "é›·é›¨", 96: "é›·é›¨(é›¹)"
        };

        // æ™‚åˆ»ã‚»ãƒƒãƒˆ
        function setNow(id) {
            document.getElementById(id).value = new Date().toTimeString().slice(0, 5);
        }

        // GPS & å¤©æ°—å–å¾—
        function getGPSAndWeather() {
            if (!navigator.geolocation) { alert("GPSéå¯¾å¿œã§ã™"); return; }
            const btn = document.querySelector('.btn-gps');
            btn.innerText = "æ¸¬ä½ä¸­...";
            
            navigator.geolocation.getCurrentPosition(async pos => {
                const lat = pos.coords.latitude.toFixed(5);
                const lon = pos.coords.longitude.toFixed(5);
                document.getElementById('my_location').value = `${lat}, ${lon}`;
                btn.innerText = "âœ… å–å¾—å®Œäº†";

                try {
                    btn.innerText = "å¤©æ°—å–å¾—ä¸­...";
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,weather_code&timezone=Asia%2FTokyo`;
                    
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        const cur = data.current;
                        
                        document.getElementById('temp').value = cur.temperature_2m;
                        document.getElementById('humid').value = cur.relative_humidity_2m;
                        document.getElementById('press').value = cur.surface_pressure;
                        document.getElementById('wind').value = cur.wind_speed_10m;
                        
                        const wCode = cur.weather_code;
                        document.getElementById('weather').value = weatherCodes[wCode] || "ä¸æ˜";
                        
                        btn.innerText = "âœ… GPS & å¤©æ°—å®Œäº†";
                    } else { throw new Error("API Error"); }
                } catch(e) {
                    btn.innerText = "âš ï¸ GPSã®ã¿å®Œäº† (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)";
                }
                setTimeout(() => btn.innerText = "ğŸ›°ï¸ GPS & å¤©æ°—å–å¾—", 3000);

            }, err => {
                alert("GPSã‚¨ãƒ©ãƒ¼: " + err.message);
                btn.innerText = "ğŸ›°ï¸ GPS & å¤©æ°—å–å¾—";
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog() {
            const callInput = document.getElementById('callsign');
            callInput.value = callInput.value.toUpperCase(); // è‡ªå‹•å¤§æ–‡å­—åŒ–ã¯ç¶­æŒ

            const entry = {
                start_time: `${document.getElementById('date').value} ${document.getElementById('time').value}`,
                callsign: callInput.value,
                band: document.getElementById('band').value,
                channel: document.getElementById('channel').value,
                rs: document.getElementById('rs').value,
                my_location: document.getElementById('my_location').value,
                location: document.getElementById('location').value,
                content: document.getElementById('content').value,
                
                weather: document.getElementById('weather').value,
                temperature: document.getElementById('temp').value,
                humidity: document.getElementById('humid').value,
                pressure: document.getElementById('press').value,
                wind_speed: document.getElementById('wind').value
            };

            if(!entry.callsign) { alert("ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            logs.unshift(entry);
            saveAndRender();
            
            // å…¥åŠ›ã‚¯ãƒªã‚¢ï¼ˆé€£ç¶šé‹ç”¨ã®ãŸã‚ã«å ´æ‰€ãƒ»å¤©æ°—ãƒ»æ—¥æ™‚ã¯æ®‹ã™ï¼‰
            document.getElementById('callsign').value = "";
            document.getElementById('rs').value = "";
            document.getElementById('content').value = "";
            
            // æ™‚åˆ»ã‚’ç¾åœ¨ã«æ›´æ–°
            setNow('time');
            
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "ğŸ‘ ä¿å­˜ã—ã¾ã—ãŸ";
            btn.style.background = "#218838";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "";
            }, 1500);
        }

        function exportJSON() {
            if(logs.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            const jsonStr = JSON.stringify(logs, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobile_log_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function saveAndRender() {
            localStorage.setItem('radio_logs', JSON.stringify(logs));
            renderLogs();
        }

        function renderLogs() {
            const list = document.getElementById('logList');
            list.innerHTML = "";
            document.getElementById('count').innerText = logs.length;
            
            logs.forEach((log, index) => {
                const li = document.createElement('li');
                li.className = "log-item";
                li.innerHTML = `
                    <div>
                        <div class="log-info">${log.callsign} <span style="font-size:12px; color:#007bff; border:1px solid #cce5ff; padding:1px 4px; border-radius:4px;">${log.band}</span></div>
                        <div class="log-sub">${log.start_time.slice(5)} | ${log.my_location || 'No Loc'} | ${log.weather || '-'}</div>
                    </div>
                    <button onclick="deleteLog(${index})" style="width:auto; padding:6px 12px; margin:0; background:#f8f9fa; color:#dc3545; border:1px solid #dee2e6;">å‰Šé™¤</button>
                `;
                list.appendChild(li);
            });
        }

        function deleteLog(index) {
            if(confirm("ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                logs.splice(index, 1);
                saveAndRender();
            }
        }

        function clearLogs() {
            if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                logs = [];
                saveAndRender();
            }
        }
    </script>
</body>
</html>
