<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Log Mobile</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #ffc107;
            --bg: #f2f2f7;
            --card-bg: #ffffff;
            --text: #333;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); -webkit-text-size-adjust: 100%; }
        
        .card { background: var(--card-bg); padding: 16px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 16px; }
        .row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 12px; }
        .col { flex: 1; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; color: #666; }
        
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; 
            font-size: 17px; box-sizing: border-box; background: #fff; appearance: none; -webkit-appearance: none;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; background: #fff; }
        
        /* GPSã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä»˜ããƒœã‚¿ãƒ³ */
        .btn-start { 
            background: #6c757d; color: white; font-size: 18px; margin-bottom: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: background 0.3s;
        }
        .gps-locked { background: #007bff !important; box-shadow: 0 0 15px rgba(0,123,255,0.5); }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-end { background: #6c757d; color: white; margin-bottom: 15px; }
        .btn-save { background: var(--success); color: white; font-size: 20px; padding: 16px; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        .btn-gps { background: #e3f2fd; color: var(--primary); font-size: 14px; padding: 10px; border: 1px solid #b3d7ff;}
        .btn-share { background: #6610f2; color: white; margin-bottom: 8px; }
        .btn-copy { background: #17a2b8; color: white; margin-bottom: 8px; }
        .btn-clear { background: transparent; color: #dc3545; font-size: 12px; border: 1px solid #eee; width: auto; margin: 10px auto; padding: 8px 15px;}
        
        .footer-area { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px; }
        #status-bar { font-size: 12px; text-align: center; margin-bottom: 5px; color: #666; height: 18px;}

        /* â˜…è¿½åŠ : ãƒ­ã‚°ãƒªã‚¹ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="card">
        <div id="status-bar">GPSå¾…æ©Ÿä¸­...</div>
        <button type="button" class="btn-start" id="startBtn" onclick="startQSO()">ğŸ“¡ äº¤ä¿¡é–‹å§‹ (GPSå–å¾—)</button>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label>é–‹å§‹æ™‚åˆ»</label>
                <input type="time" id="time">
            </div>
        </div>

        <label style="color:var(--primary); font-size:14px;">ç›¸æ‰‹å±€ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³</label>
        <input type="text" id="callsign" placeholder="ä¾‹: ãƒˆã‚¦ã‚­ãƒ§ã‚¦AB123">
        
        <div class="row" style="margin-top:12px;">
            <div class="col" style="flex:1.2;">
                <label>Band (å‰å›ç¶­æŒ)</label>
                <select id="band">
                    <option value="å¸‚æ°‘ãƒ©ã‚¸ã‚ª/CB">CB (å¸‚æ°‘ãƒ©ã‚¸ã‚ª)</option>
                    <option value="ãƒ‡ã‚¸ã‚¿ãƒ«ç°¡æ˜“ç„¡ç·š/DCR">DCR (ãƒ‡ã‚¸ç°¡)</option>
                    <option value="ç‰¹å®šå°é›»åŠ›ç„¡ç·š/SLPR">ç‰¹å° (SLPR)</option>
                    <option value="ãƒ‡ã‚¸ã‚¿ãƒ«å°é›»åŠ›ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£/LCR">LCR (ãƒ‡ã‚¸ã‚³ãƒŸ)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col"><label>Ch</label><input type="text" id="channel" placeholder="ch" inputmode="decimal"></div>
            <div class="col"><label>RS</label><input type="text" id="rs" placeholder="59" inputmode="numeric" pattern="\d*"></div>
        </div>

        <div style="margin-bottom:12px;">
            <label>ç›¸æ‰‹é‹ç”¨åœ°</label>
            <input type="text" id="location" placeholder="é‹ç”¨åœ°ãªã©">
        </div>
        <div style="margin-bottom:15px;">
            <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="content" rows="2" placeholder="å‚™è€ƒãƒ¡ãƒ¢"></textarea>
        </div>

        <div class="row">
             <div class="col"><label>çµ‚äº†æ™‚åˆ»</label><input type="time" id="end_time"></div>
             <div class="col"><button type="button" class="btn-end" style="margin-top:22px; margin-bottom:0;" onclick="setNow('end_time')">çµ‚äº† (Now)</button></div>
        </div>
        
        <hr style="border:0; margin:15px 0;">
        <button type="button" class="btn-save" onclick="addLog()">ğŸ’¾ ãƒ­ã‚°ã‚’ä¿å­˜</button>
    </div>

    <div class="card footer-area">
        <label>ğŸ“ ä½ç½®æƒ…å ± & å¤©æ°—</label>
        <div class="row">
            <div class="col"><button type="button" class="btn-gps" onclick="getGPSAndWeather()">ğŸ›°ï¸ æ‰‹å‹•æ›´æ–°</button></div>
        </div>
        <div style="font-size:12px; color:#666; background:#f9f9f9; padding:8px; border-radius:6px; margin-bottom:10px;">
            <div>ä½ç½®: <span id="loc-disp">æœªå–å¾—</span></div>
            <div>å¤©æ°—: <span id="weather-disp">--</span> <span id="temp-disp">--</span></div>
            <input type="date" id="date" style="margin-top:5px; font-size:14px; padding:5px;">
        </div>

        <input type="hidden" id="my_location">
        <input type="hidden" id="weather"><input type="hidden" id="temp">
        <input type="hidden" id="humid"><input type="hidden" id="press"><input type="hidden" id="wind">

        <h3 style="margin:10px 0 5px; font-size:15px;">ä¿å­˜æ¸ˆã¿: <span id="count">0</span>ä»¶</h3>
        <button type="button" class="btn-share" onclick="smartShare()">ğŸ“¤ ã‚¹ãƒãƒ¼ãƒˆè»¢é€</button>
        <button type="button" class="btn-copy" onclick="copyJSON()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
        <ul id="logList" style="margin-top:10px; border-top:1px solid #eee; padding-left:0; list-style:none;"></ul>
        <div style="text-align:center;">
             <button type="button" class="btn-clear" onclick="clearLogs()">ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</button>
        </div>
    </div>

    <script>
        const weatherCodes = { 0:"å¿«æ™´", 1:"æ™´ã‚Œ", 2:"ä¸€éƒ¨æ›‡", 3:"æ›‡ã‚Š", 45:"éœ§", 61:"é›¨", 80:"é©Ÿé›¨", 95:"é›·é›¨" };
        
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('date').value = now.toISOString().slice(0, 10);
            
            const pref = JSON.parse(localStorage.getItem('radio_pref')) || {};
            if(pref.band) document.getElementById('band').value = pref.band;
            if(pref.my_location) {
                document.getElementById('my_location').value = pref.my_location;
                document.getElementById('loc-disp').innerText = "å‰å›å€¤ä½¿ç”¨";
                document.getElementById('startBtn').classList.add('gps-locked');
                document.getElementById('startBtn').innerText = "ğŸ“¡ äº¤ä¿¡é–‹å§‹ (Ready)";
            }
            renderLogs();
        });

        function setNow(id) {
            document.getElementById(id).value = new Date().toTimeString().slice(0, 5);
        }

        function startQSO() {
            setNow('time');
            getGPSAndWeather();
        }

        function getGPSAndWeather() {
            if (!navigator.geolocation) return;
            
            const status = document.getElementById('status-bar');
            const btn = document.getElementById('startBtn');
            const disp = document.getElementById('loc-disp');

            status.innerText = "ğŸ›°ï¸ è¡›æ˜Ÿæ•æ‰ä¸­...";
            btn.classList.remove('gps-locked');
            
            navigator.geolocation.getCurrentPosition(async pos => {
                const lat = pos.coords.latitude.toFixed(5);
                const lon = pos.coords.longitude.toFixed(5);
                const coordStr = `${lat}, ${lon}`;
                
                document.getElementById('my_location').value = coordStr;
                disp.innerText = coordStr;
                status.innerText = "âœ… æ¸¬ä½å®Œäº†";
                
                btn.classList.add('gps-locked');
                btn.innerText = "ğŸ“¡ äº¤ä¿¡é–‹å§‹ (Ready)";

                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,weather_code&timezone=Asia%2FTokyo`;
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        const cur = data.current;
                        const wName = weatherCodes[cur.weather_code] || "ä¸æ˜";
                        
                        document.getElementById('weather-disp').innerText = wName;
                        document.getElementById('temp-disp').innerText = cur.temperature_2m + "â„ƒ";
                        document.getElementById('weather').value = wName;
                        document.getElementById('temp').value = cur.temperature_2m;
                        document.getElementById('humid').value = cur.relative_humidity_2m;
                        document.getElementById('press').value = cur.surface_pressure;
                        document.getElementById('wind').value = cur.wind_speed_10m;
                    }
                } catch(e) { 
                    document.getElementById('weather-disp').innerText = "(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)"; 
                }
            }, err => { 
                status.innerText = "âš ï¸ GPSã‚¨ãƒ©ãƒ¼: " + err.message;
                disp.innerText = "æœªå–å¾—";
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        function addLog() {
            const callInput = document.getElementById('callsign');
            const callsign = callInput.value.trim(); 
            if(!callsign) { alert("ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            
            let myLoc = document.getElementById('my_location').value;
            if (!myLoc.match(/[0-9.]+, [0-9.]+/)) {
                myLoc = "";
            }

            const endTimeVal = document.getElementById('end_time').value;
            const endTimeStr = endTimeVal ? `${document.getElementById('date').value} ${endTimeVal}` : "";

            const entry = {
                start_time: `${document.getElementById('date').value} ${document.getElementById('time').value}`,
                end_time: endTimeStr,
                callsign: callsign,
                band: document.getElementById('band').value,
                channel: document.getElementById('channel').value,
                rs: document.getElementById('rs').value,
                my_location: myLoc,
                location: document.getElementById('location').value,
                content: document.getElementById('content').value,
                weather: document.getElementById('weather').value,
                temperature: document.getElementById('temp').value,
                humidity: document.getElementById('humid').value,
                pressure: document.getElementById('press').value,
                wind_speed: document.getElementById('wind').value
            };

            let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
            logs.unshift(entry);
            localStorage.setItem('radio_logs', JSON.stringify(logs));

            localStorage.setItem('radio_pref', JSON.stringify({
                band: entry.band,
                my_location: entry.my_location
            }));

            renderLogs();
            
            callInput.value = "";
            document.getElementById('channel').value = "";
            document.getElementById('rs').value = "";
            document.getElementById('location').value = "";
            document.getElementById('content').value = "";
            document.getElementById('end_time').value = "";
            document.getElementById('time').value = ""; 

            const btn = document.querySelector('.btn-save');
            const originalColor = btn.style.background;
            btn.style.background = "#28a745";
            btn.innerText = "âœ… ä¿å­˜å®Œäº†ï¼";
            setTimeout(() => {
                btn.style.background = originalColor;
                btn.innerText = "ğŸ’¾ ãƒ­ã‚°ã‚’ä¿å­˜";
            }, 1000);
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        async function smartShare() {
            let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
            if(logs.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }

            const jsonStr = JSON.stringify(logs, null, 2);
            const fileName = `mobile_${new Date().toISOString().slice(0,10)}.json`;
            const file = new File([jsonStr], fileName, {type: "application/json"});

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({ files: [file], title: 'Radio Log', text: 'äº¤ä¿¡ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã§ã™' });
                } catch (err) { console.log("Share cancelled", err); }
            } else {
                alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒå…±æœ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ã€‚");
                copyJSON();
            }
        }

        function copyJSON() {
            let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
            if(logs.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
            navigator.clipboard.writeText(JSON.stringify(logs, null, 2)).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
        }

        function renderLogs() {
            let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
            const list = document.getElementById('logList');
            list.innerHTML = "";
            document.getElementById('count').innerText = logs.length;
            
            logs.forEach((log, index) => {
                // â˜…è¿½åŠ : åœ°å›³ãƒªãƒ³ã‚¯ã®ç”Ÿæˆï¼ˆGoogleãƒãƒƒãƒ—ã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ï¼‰
                let mapLink = "";
                if (log.my_location) {
                    // APIã‚­ãƒ¼ä¸è¦ã§ã‚¹ãƒãƒ›ã®åœ°å›³ã‚¢ãƒ—ãƒªãŒç«‹ã¡ä¸ŠãŒã‚‹å®‰å…¨ãªãƒªãƒ³ã‚¯ã§ã™
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(log.my_location)}`;
                    mapLink = `<a href="${mapUrl}" target="_blank" style="font-size:12px; color:#007bff; text-decoration:none; margin-left:8px; display:inline-block; background:#e3f2fd; padding:2px 6px; border-radius:4px;">ğŸ“åœ°å›³</a>`;
                }

                const li = document.createElement('li');
                li.className = "log-item";
                li.innerHTML = `
                    <div style="flex:1;">
                        <div class="log-main" style="font-weight:bold;">${log.callsign} <span style="font-size:12px; font-weight:normal; background:#eee; padding:2px 5px; border-radius:4px;">${log.band}</span></div>
                        <div class="log-sub" style="font-size:12px; color:#666; margin-top:4px;">${log.start_time.slice(11,16)} ${mapLink}</div>
                    </div>
                    <button onclick="deleteLog(${index})" style="width:auto; height:fit-content; padding:6px 12px; background:#f8f9fa; color:#dc3545; border:1px solid #ddd; font-size:12px;">å‰Šé™¤</button>
                `;
                list.appendChild(li);
            });
        }
        
        function deleteLog(i) {
            let logs = JSON.parse(localStorage.getItem('radio_logs')) || [];
            logs.splice(i, 1);
            localStorage.setItem('radio_logs', JSON.stringify(logs));
            renderLogs();
        }
        
        function clearLogs() {
            if(confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('radio_logs');
                renderLogs();
            }
        }
    </script>
</body>
</html>
